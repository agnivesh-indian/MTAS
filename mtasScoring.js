/**
 * MTAS FULL SCORING DATASET
 * Includes: Bayesian Distribution, Percentiles, and Z-Scores.
 * Column Indices: 0=11yr, 1=12yr, 2=13yr, 3=14yr, 4=15yr, 5=16yr, 6=17yr, 7=18yr.
 * Row Indices: score - 16.
 */

const MTAS_DATA = {
    bayesianNorms: [
        { "z": "-3.5", "increment": 0.1, "cumulative": 0.0 },
        { "z": "-3", "increment": 0.5, "cumulative": 0.1 },
        { "z": "-2.5", "increment": 1.7, "cumulative": 0.6 },
        { "z": "-2", "increment": 4.4, "cumulative": 2.3 },
        { "z": "-1.5", "increment": 9.2, "cumulative": 6.7 },
        { "z": "-1", "increment": 15.0, "cumulative": 15.9 },
        { "z": "-0.5", "increment": 19.1, "cumulative": 30.9 },
        { "z": "0 (Mean)", "increment": null, "cumulative": 50.0 },
        { "z": "+0.5", "increment": 19.1, "cumulative": 69.1 },
        { "z": "+1", "increment": 15.0, "cumulative": 84.1 },
        { "z": "+1.5", "increment": 9.2, "cumulative": 93.3 },
        { "z": "+2", "increment": 4.4, "cumulative": 97.7 },
        { "z": "+2.5", "increment": 1.7, "cumulative": 99.4 },
        { "z": "+3", "increment": 0.5, "cumulative": 99.9 },
        { "z": "+3.5", "increment": 0.1, "cumulative": 100.0 }
    ],

    // Percentile Ranks - Male (Indices: 0=11yr...7=18yr)
    percentile_male: [[1, 1, 1, 1, 1, 1, 1, 2], [2, 2, 1, 2, 2, 1, 1, 2], [2, 2, 1, 2, 2, 1, 2, 2], [2, 2, 2, 2, 2, 2, 2, 3], [2, 2, 2, 2, 2, 2, 2, 4], [2, 3, 4, 3, 3, 2, 2, 4], [3, 4, 4, 3, 3, 3, 3, 4], [3, 6, 5, 4, 3, 3, 3, 5], [5, 6, 5, 5, 3, 3, 4, 5], [7, 7, 5, 5, 4, 4, 4, 5], [8, 7, 7, 6, 4, 5, 5, 6], [8, 8, 7, 6, 5, 6, 5, 7], [8, 10, 7, 8, 5, 6, 6, 7], [8, 10, 7, 8, 5, 7, 7, 7], [11, 11, 9, 9, 7, 8, 7, 8], [12, 12, 10, 11, 7, 9, 9, 8], [15, 14, 11, 12, 9, 10, 9, 9], [15, 16, 11, 12, 9, 13, 12, 12], [15, 18, 13, 13, 10, 14, 13, 15], [20, 18, 14, 16, 10, 16, 15, 16], [23, 20, 16, 17, 12, 18, 16, 17], [24, 24, 20, 19, 14, 20, 20, 18], [27, 26, 24, 20, 16, 23, 21, 20], [30, 29, 25, 23, 19, 26, 22, 21], [33, 32, 28, 25, 21, 29, 24, 24], [35, 35, 32, 27, 24, 32, 26, 25], [36, 37, 35, 32, 26, 35, 28, 28], [38, 40, 41, 35, 30, 37, 30, 32], [43, 44, 43, 39, 34, 41, 33, 33], [45, 48, 45, 41, 39, 43, 37, 35], [46, 51, 46, 44, 42, 47, 40, 37], [51, 55, 49, 46, 46, 49, 44, 40], [52, 57, 54, 49, 54, 52, 49, 44], [55, 61, 59, 52, 55, 56, 53, 47], [63, 64, 63, 56, 60, 61, 55, 52], [64, 67, 67, 58, 65, 64, 58, 54], [65, 69, 71, 63, 68, 66, 62, 58], [69, 73, 75, 64, 71, 69, 65, 62], [75, 75, 79, 69, 74, 72, 69, 64], [77, 77, 82, 73, 77, 75, 72, 66], [79, 79, 84, 75, 79, 78, 75, 67], [85, 81, 87, 78, 79, 81, 77, 70], [87, 84, 88, 79, 82, 83, 81, 72], [87, 85, 90, 83, 86, 85, 83, 76], [88, 88, 90, 86, 87, 88, 85, 79], [89, 88, 91, 87, 89, 89, 86, 81], [92, 89, 93, 90, 90, 91, 88, 85], [95, 90, 95, 93, 92, 92, 90, 86], [96, 91, 95, 94, 94, 93, 92, 87], [96, 92, 96, 94, 94, 94, 93, 88], [96, 94, 97, 95, 94, 95, 94, 90], [96, 96, 97, 95, 94, 96, 94, 92], [97, 97, 98, 96, 95, 96, 95, 92], [97, 97, 98, 96, 96, 97, 96, 93], [98, 99, 99, 97, 96, 97, 96, 94], [98, 99, 99, 98, 96, 98, 97, 94], [99, 99, 99, 99, 98, 98, 98, 94], [99, 100, 100, 99, 98, 98, 98, 96], [100, 100, 100, 100, 99, 99, 99, 97], [100, 100, 100, 100, 100, 99, 99, 97], [100, 100, 100, 100, 100, 100, 99, 97], [100, 100, 100, 100, 100, 100, 100, 98], [100, 100, 100, 100, 100, 100, 100, 98], [100, 100, 100, 100, 100, 100, 100, 100], [100, 100, 100, 100, 100, 100, 100, 100]],

    // Percentile Ranks - Female
    percentile_female: [[1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 2, 1, 1, 1, 1], [2, 1, 1, 2, 1, 1, 1, 1], [2, 3, 2, 2, 1, 1, 1, 1], [2, 3, 2, 2, 1, 1, 1, 1], [3, 3, 2, 2, 1, 1, 1, 1], [3, 3, 2, 2, 1, 1, 1, 1], [4, 3, 2, 2, 1, 1, 1, 1], [4, 3, 2, 3, 1, 1, 1, 1], [4, 4, 3, 3, 2, 1, 2, 1], [4, 4, 4, 3, 2, 1, 2, 1], [4, 4, 4, 3, 2, 1, 2, 1], [5, 4, 4, 4, 2, 1, 2, 1], [5, 4, 4, 4, 3, 2, 2, 1], [5, 4, 5, 5, 3, 3, 3, 3], [7, 5, 6, 6, 3, 3, 3, 4], [8, 5, 6, 6, 4, 4, 3, 4], [9, 9, 7, 8, 5, 4, 4, 4], [12, 10, 8, 8, 6, 5, 4, 5], [15, 11, 9, 10, 8, 5, 5, 5], [16, 12, 12, 11, 8, 7, 5, 7], [17, 14, 14, 13, 9, 8, 5, 8], [22, 16, 16, 14, 11, 8, 6, 9], [25, 17, 18, 16, 13, 10, 7, 10], [27, 21, 21, 18, 15, 11, 8, 12], [32, 23, 24, 20, 18, 12, 9, 13], [34, 26, 27, 23, 21, 14, 12, 15], [37, 30, 28, 27, 24, 18, 13, 18], [42, 35, 32, 32, 28, 21, 16, 21], [43, 39, 36, 36, 31, 23, 17, 23], [46, 40, 39, 39, 32, 24, 19, 24], [47, 43, 42, 41, 33, 26, 21, 25], [51, 47, 45, 43, 38, 29, 23, 28], [53, 50, 49, 46, 40, 33, 27, 31], [55, 54, 53, 49, 44, 36, 31, 33], [61, 58, 57, 53, 48, 42, 34, 38], [63, 61, 61, 56, 52, 45, 39, 41], [65, 65, 64, 60, 56, 48, 43, 44], [69, 68, 67, 64, 60, 53, 47, 47], [72, 72, 70, 68, 61, 56, 51, 51], [75, 76, 73, 71, 63, 60, 54, 54], [77, 80, 77, 74, 65, 64, 57, 58], [79, 82, 81, 77, 69, 67, 62, 61], [82, 85, 84, 81, 74, 71, 67, 64], [86, 87, 86, 83, 79, 74, 71, 68], [88, 89, 88, 86, 82, 78, 74, 71], [90, 91, 91, 89, 86, 82, 78, 75], [92, 93, 93, 91, 88, 85, 82, 78], [94, 94, 94, 92, 90, 87, 84, 81], [95, 95, 96, 93, 92, 90, 86, 84], [96, 96, 96, 94, 93, 92, 89, 86], [97, 97, 98, 96, 94, 93, 91, 89], [98, 98, 99, 97, 96, 95, 93, 92], [98, 99, 99, 98, 97, 96, 94, 93], [99, 99, 99, 98, 98, 97, 96, 94], [99, 100, 100, 99, 98, 98, 97, 96], [100, 100, 100, 99, 99, 98, 98, 97], [100, 100, 100, 99, 99, 99, 98, 98], [100, 100, 100, 100, 99, 99, 99, 99], [100, 100, 100, 100, 100, 99, 99, 99], [100, 100, 100, 100, 100, 100, 100, 100], [100, 100, 100, 100, 100, 100, 100, 100]],

    // Z-Scores - Male
    zscore_male: [[-2.5, -2.43, -2.71, -2.62, -2.88, -2.65, -2.56, -2.51], [-2.41, -2.35, -2.62, -2.53, -2.79, -2.56, -2.48, -2.43], [-2.33, -2.27, -2.53, -2.44, -2.71, -2.48, -2.39, -2.36], [-2.25, -2.19, -2.44, -2.35, -2.62, -2.39, -2.31, -2.29], [-2.17, -2.11, -2.35, -2.26, -2.53, -2.31, -2.23, -2.21], [-2.09, -2.03, -2.26, -2.17, -2.44, -2.23, -2.14, -2.14], [-2.01, -1.95, -2.17, -2.09, -2.35, -2.14, -2.06, -2.07], [-1.93, -1.86, -2.08, -2.0, -2.26, -2.06, -1.98, -1.99], [-1.85, -1.78, -1.99, -1.91, -2.18, -1.97, -1.9, -1.92], [-1.77, -1.7, -1.9, -1.82, -2.09, -1.89, -1.81, -1.85], [-1.69, -1.62, -1.81, -1.73, -2.0, -1.8, -1.73, -1.77], [-1.61, -1.54, -1.72, -1.64, -1.92, -1.72, -1.64, -1.7], [-1.53, -1.46, -1.63, -1.56, -1.83, -1.63, -1.56, -1.63], [-1.45, -1.38, -1.54, -1.47, -1.74, -1.55, -1.48, -1.55], [-1.37, -1.3, -1.45, -1.38, -1.65, -1.46, -1.39, -1.48], [-1.29, -1.22, -1.36, -1.29, -1.56, -1.38, -1.31, -1.41], [-1.21, -1.14, -1.27, -1.2, -1.48, -1.29, -1.23, -1.33], [-1.13, -1.06, -1.18, -1.11, -1.39, -1.21, -1.14, -1.26], [-1.05, -0.98, -1.09, -1.03, -1.3, -1.12, -1.06, -1.19], [-0.97, -0.9, -1.0, -0.94, -1.21, -1.04, -0.98, -1.11], [-0.89, -0.81, -0.91, -0.85, -1.13, -0.96, -0.89, -1.04], [-0.81, -0.73, -0.83, -0.76, -1.04, -0.87, -0.81, -0.97], [-0.73, -0.65, -0.74, -0.67, -0.95, -0.79, -0.73, -0.89], [-0.64, -0.57, -0.65, -0.58, -0.86, -0.7, -0.64, -0.82], [-0.55, -0.51, -0.58, -0.66, -0.76, -0.63, -0.72, -0.74], [-0.48, -0.41, -0.47, -0.4, -0.69, -0.53, -0.48, -0.67], [-0.4, -0.33, -0.38, -0.31, -0.6, -0.45, -0.4, -0.6], [-0.32, -0.25, -0.29, -0.23, -0.51, -0.36, -0.31, -0.52], [-0.24, -0.17, -0.2, -0.14, -0.42, -0.28, -0.23, -0.45], [-0.16, -0.09, -0.11, -0.05, -0.34, -0.19, -0.15, -0.38], [-0.08, -0.01, -0.02, 0.04, -0.25, -0.11, -0.06, -0.3], [0, 0.07, 0.07, 0.13, -0.16, -0.02, 0.02, -0.23], [0.08, 0.15, 0.16, 0.22, -0.07, 0.06, 0.1, -0.15], [0.16, 0.23, 0.25, 0.31, 0.02, 0.15, 0.19, -0.08], [0.24, 0.31, 0.34, 0.4, 0.11, 0.23, 0.27, -0.01], [0.32, 0.39, 0.43, 0.49, 0.2, 0.32, 0.35, 0.07], [0.4, 0.47, 0.52, 0.58, 0.28, 0.4, 0.43, 0.14], [0.48, 0.55, 0.61, 0.67, 0.37, 0.49, 0.52, 0.21], [0.56, 0.63, 0.7, 0.76, 0.46, 0.57, 0.6, 0.29], [0.64, 0.71, 0.79, 0.85, 0.55, 0.65, 0.68, 0.36], [0.72, 0.79, 0.88, 0.94, 0.64, 0.74, 0.77, 0.44], [0.8, 0.87, 0.97, 1.03, 0.73, 0.82, 0.85, 0.51], [0.88, 0.95, 1.06, 1.12, 0.82, 0.91, 0.93, 0.58], [0.96, 1.03, 1.15, 1.21, 0.91, 1.0, 1.01, 0.66], [1.07, 1.09, 1.19, 0.98, 1.0, 1.05, 0.92, 0.73], [1.13, 1.2, 1.33, 1.39, 1.09, 1.17, 1.18, 0.81], [1.21, 1.28, 1.42, 1.48, 1.18, 1.25, 1.26, 0.88], [1.29, 1.36, 1.51, 1.57, 1.27, 1.34, 1.35, 0.96], [1.37, 1.44, 1.6, 1.66, 1.36, 1.42, 1.43, 1.03], [1.45, 1.52, 1.69, 1.75, 1.45, 1.51, 1.51, 1.1], [1.53, 1.6, 1.78, 1.84, 1.53, 1.59, 1.59, 1.18], [1.61, 1.68, 1.87, 1.93, 1.62, 1.68, 1.68, 1.25], [1.69, 1.76, 1.96, 2.02, 1.71, 1.76, 1.76, 1.33], [1.77, 1.84, 2.05, 2.11, 1.80, 1.85, 1.84, 1.4], [1.85, 1.92, 2.14, 2.2, 1.89, 1.93, 1.93, 1.48], [1.93, 2.0, 2.23, 2.29, 1.98, 2.02, 2.01, 1.55], [2.01, 2.08, 2.32, 2.38, 2.07, 2.1, 2.09, 1.62], [2.09, 2.16, 2.41, 2.47, 2.16, 2.19, 2.17, 1.7], [2.17, 2.24, 2.5, 2.56, 2.25, 2.27, 2.26, 1.77], [2.25, 2.32, 2.59, 2.65, 2.34, 2.36, 2.34, 1.85], [2.33, 2.41, 2.68, 2.74, 2.43, 2.44, 2.42, 1.92], [2.41, 2.49, 2.77, 2.83, 2.52, 2.53, 2.51, 1.99], [2.49, 2.57, 2.86, 2.92, 2.61, 2.61, 2.59, 2.07], [2.57, 2.65, 2.95, 3.01, 2.7, 2.7, 2.67, 2.14], [2.65, 2.73, 3.04, 3.1, 2.79, 2.78, 2.75, 2.22]],

    // Z-Scores - Female
    zscore_female: [[-3.1, -3.52, -3.38, -2.94, -2.98, -3.07, -2.99, -2.96], [-3.01, -3.42, -3.29, -2.85, -2.9, -2.99, -2.9, -2.88], [-2.92, -3.32, -3.19, -2.77, -2.81, -2.9, -2.82, -2.81], [-2.84, -3.23, -3.1, -2.69, -2.73, -2.82, -2.74, -2.73], [-2.75, -3.13, -3.01, -2.6, -2.65, -2.74, -2.65, -2.65], [-2.66, -3.03, -2.92, -2.52, -2.57, -2.65, -2.57, -2.58], [-2.57, -2.93, -2.82, -2.44, -2.48, -2.57, -2.49, -2.5], [-2.48, -2.84, -2.73, -2.35, -2.4, -2.49, -2.4, -2.43], [-2.4, -2.74, -2.64, -2.27, -2.31, -2.4, -2.32, -2.35], [-2.31, -2.65, -2.55, -2.19, -2.23, -2.32, -2.23, -2.28], [-2.22, -2.55, -2.45, -2.1, -2.15, -2.23, -2.15, -2.2], [-2.13, -2.45, -2.36, -2.02, -2.06, -2.15, -2.07, -2.13], [-2.04, -2.36, -2.27, -1.93, -1.98, -2.07, -1.98, -2.05], [-1.96, -2.26, -2.17, -1.85, -1.9, -1.98, -1.9, -1.98], [-1.87, -2.16, -2.08, -1.77, -1.81, -1.9, -1.82, -1.9], [-1.78, -2.07, -1.99, -1.68, -1.73, -1.82, -1.73, -1.83], [-1.69, -1.97, -1.9, -1.6, -1.65, -1.73, -1.65, -1.75], [-1.61, -1.88, -1.8, -1.52, -1.56, -1.65, -1.56, -1.68], [-1.52, -1.78, -1.71, -1.43, -1.48, -1.56, -1.48, -1.6], [-1.43, -1.68, -1.62, -1.35, -1.4, -1.48, -1.4, -1.53], [-1.34, -1.59, -1.52, -1.27, -1.31, -1.39, -1.31, -1.45], [-1.25, -1.49, -1.43, -1.18, -1.23, -1.31, -1.23, -1.38], [-1.17, -1.4, -1.34, -1.1, -1.15, -1.23, -1.15, -1.3], [-1.08, -1.3, -1.25, -1.02, -1.06, -1.14, -1.06, -1.23], [-0.99, -1.21, -1.15, -0.93, -0.98, -1.06, -0.98, -1.15], [-0.9, -1.11, -1.06, -0.85, -0.9, -0.98, -0.9, -1.08], [-0.81, -1.01, -0.97, -0.77, -0.81, -0.89, -0.81, -1], [-0.73, -0.92, -0.88, -0.68, -0.73, -0.81, -0.73, -0.93], [-0.64, -0.82, -0.78, -0.6, -0.65, -0.73, -0.65, -0.85], [-0.55, -0.73, -0.69, -0.52, -0.56, -0.64, -0.56, -0.78], [-0.46, -0.63, -0.6, -0.43, -0.48, -0.56, -0.48, -0.7], [-0.37, -0.53, -0.5, -0.35, -0.4, -0.48, -0.4, -0.63], [-0.28, -0.44, -0.41, -0.27, -0.31, -0.39, -0.31, -0.55], [-0.19, -0.34, -0.32, -0.19, -0.23, -0.31, -0.23, -0.48], [-0.1, -0.25, -0.23, -0.1, -0.15, -0.23, -0.15, -0.4], [-0.01, -0.15, -0.13, -0.02, -0.06, -0.14, -0.06, -0.33], [0.08, -0.06, -0.04, 0.07, 0.02, -0.06, 0.02, -0.25], [0.17, 0.04, 0.05, 0.15, 0.1, 0.02, 0.1, -0.18], [0.26, 0.14, 0.14, 0.23, 0.18, 0.11, 0.19, -0.1], [0.35, 0.23, 0.24, 0.32, 0.27, 0.19, 0.27, -0.03], [0.44, 0.33, 0.33, 0.4, 0.35, 0.27, 0.35, 0.05], [0.52, 0.42, 0.42, 0.49, 0.43, 0.36, 0.43, 0.12], [0.61, 0.52, 0.52, 0.57, 0.52, 0.44, 0.52, 0.2], [0.7, 0.62, 0.61, 0.66, 0.6, 0.53, 0.6, 0.27], [0.79, 0.71, 0.7, 0.74, 0.68, 0.61, 0.68, 0.35], [0.88, 0.81, 0.8, 0.82, 0.77, 0.69, 0.77, 0.42], [0.97, 0.9, 0.89, 0.91, 0.85, 0.78, 0.85, 0.5], [1.06, 1.0, 0.98, 0.99, 0.93, 0.86, 0.93, 0.57], [1.14, 1.1, 1.08, 1.08, 1.02, 0.94, 1.02, 0.65], [1.23, 1.19, 1.17, 1.16, 1.1, 1.03, 1.1, 0.72], [1.32, 1.29, 1.26, 1.25, 1.18, 1.11, 1.18, 0.8], [1.41, 1.38, 1.35, 1.33, 1.27, 1.19, 1.27, 0.87], [1.5, 1.48, 1.45, 1.41, 1.35, 1.28, 1.35, 0.95], [1.59, 1.57, 1.54, 1.5, 1.44, 1.36, 1.43, 1.02], [1.68, 1.67, 1.63, 1.58, 1.52, 1.45, 1.52, 1.1], [1.77, 1.77, 1.73, 1.67, 1.6, 1.53, 1.6, 1.17], [1.86, 1.86, 1.82, 1.75, 1.69, 1.61, 1.68, 1.25], [1.94, 1.96, 1.91, 1.83, 1.77, 1.7, 1.77, 1.32], [2.03, 2.05, 2.01, 1.92, 1.85, 1.78, 1.85, 1.4], [2.12, 2.15, 2.1, 2, 1.94, 1.87, 1.93, 1.47], [2.21, 2.24, 2.19, 2.09, 2.02, 1.95, 2.02, 1.55], [2.30, 2.34, 2.29, 2.17, 2.11, 2.03, 2.1, 1.62], [2.39, 2.43, 2.38, 2.26, 2.19, 2.12, 2.18, 1.7], [2.48, 2.53, 2.47, 2.34, 2.27, 2.2, 2.27, 1.77], [2.57, 2.62, 2.57, 2.42, 2.36, 2.28, 2.35, 1.85], [2.66, 2.72, 2.66, 2.51, 2.44, 2.37, 2.43, 1.92]],

    // Helper functions
    getRowIndex: (score) => score - 16,
    getAgeIndex: (age) => {
        const index = age - 11;
        if (index < 0 || index > 7) throw new Error("Age must be between 11 and 18.");
        return index;
    }
};

/**
 * SCORING LOGIC
 */
function scoreMTAS(age, gender, responses) {
    if (responses.length !== 16) return { error: "Input must contain 16 values." };

    // 1. Calculate Raw Scores
    // Responses are 1-based from the user interface, convert to 0-based for array access
    const adjustedResponses = responses.map(response => response - 1);

    const total = adjustedResponses.reduce((a, b) => a + b, 0) + 16; // Add 16 back to total to align with scores 1-5

    const subscales = {
        worry: adjustedResponses[0] + adjustedResponses[4] + adjustedResponses[8] + adjustedResponses[12] + 4,
        interference: adjustedResponses[1] + adjustedResponses[5] + adjustedResponses[9] + adjustedResponses[13] + 4,
        tension: adjustedResponses[2] + adjustedResponses[6] + adjustedResponses[10] + adjustedResponses[14] + 4,
        physiological: adjustedResponses[3] + adjustedResponses[7] + adjustedResponses[11] + adjustedResponses[15] + 4
    };

    // 2. Perform Lookup
    const rIdx = MTAS_DATA.getRowIndex(total);
    const aIdx = MTAS_DATA.getAgeIndex(age);
    const isMale = gender.toLowerCase() === 'male';

    let percentile = 'N/A';
    let zScore = 'N/A';

    try {
        if (isMale) {
            percentile = MTAS_DATA.percentile_male[rIdx][aIdx];
            zScore = MTAS_DATA.zscore_male[rIdx][aIdx];
        } else {
            percentile = MTAS_DATA.percentile_female[rIdx][aIdx];
            zScore = MTAS_DATA.zscore_female[rIdx][aIdx];
        }
    } catch (e) {
        console.error("Error looking up percentile or z-score:", e);
        // Keep as N/A
    }


    // 3. Clinical Status (Based on Bayesian sheet)
    let status = "Average";
    if (typeof zScore === 'number') { // Only determine status if zScore is a number
        if (zScore > 2.0) status = "Extremely High (Priority intervention)";
        else if (zScore > 1.5) status = "Very High";
        else if (zScore > 1.0) status = "High";
        else if (zScore < -1.0) status = "Low";
    } else {
        status = "N/A"; // Cannot determine status without a valid zScore
    }


    return { total, subscales, percentile, zScore, status };
}